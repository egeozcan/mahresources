# Mahresources Codebase Review - Consolidated Report

> Generated by a 4-agent parallel review team covering the entire ~59K LOC codebase.
> Reviewers: Backend API, Data Layer & Workers, Frontend & Templates, Tests & Infrastructure.

---

## CRITICAL (9 findings)

### Security

| # | Finding | Source | Location |
|---|---------|--------|----------|
| 1 | **Markdown renders unsafe HTML** - `html.WithUnsafe()` allows `<script>` tags in any user-authored Markdown field (notes, groups, descriptions) | Backend API | `server/template_handlers/template_filters/markdown_filter.go:29` |
| 2 | **SQL injection in FTS ranking** - Search terms interpolated into SQL via `fmt.Sprintf` instead of parameterized queries, bypassing protections | Data Layer | `fts/sqlite.go:230-239`, `fts/postgres.go:147,157-165` |
| 3 | **XSS via `x-html` with `CustomSidebar`** - Raw HTML from DB injected unescaped in lightbox and multiple display templates | Frontend | `templates/partials/lightbox.tpl:454`, `displayGroup.tpl`, `displayResource.tpl`, `displayNote.tpl` |
| 4 | **XSS via `renderMarkdown()` links** - `[text](javascript:alert(1))` bypasses the escaping in the block editor | Frontend | `src/components/blockEditor.js:47` |
| 5 | **XSS via `innerHTML` in bulk selection** - Server response HTML injected via `innerHTML` + `Alpine.initTree()` | Frontend | `src/components/bulkSelection.js:324` |
| 6 | **Database DSN printed to stdout** - Full connection string (including passwords) logged on every startup | Data Layer | `application_context/context.go:455` |
| 7 | **Unencoded error in redirect URL** - `err.Error()` interpolated into URL without encoding | Backend API | `server/api_handlers/relation_api_handlers.go:96-104` |

### Infrastructure

| # | Finding | Source | Location |
|---|---------|--------|----------|
| 8 | **No graceful shutdown** - `log.Fatal` calls `os.Exit()`, deferred cleanup never runs, in-flight requests killed | Infra | `main.go:373` |
| 9 | **Docker runs as root** - No `USER` directive, container compromise gives root access | Infra | `Dockerfile:23-35` |

---

## HIGH (17 findings)

### Data Integrity

| # | Finding | Location |
|---|---------|----------|
| 1 | **Cascading deletes on Category** - Deleting a category destroys ALL groups in it (and their sub-trees) | `models/category_model.go:14` |
| 2 | **Cascading deletes on NoteType** - Deleting a note type destroys ALL notes of that type | `models/note_type_model.go:13` |
| 3 | **Recursive group cascades** - Group deletion cascades through entire ownership hierarchy | `models/group_model.go:19,27-28` |
| 4 | **Goroutine leak in timeoutReader** - New goroutine per `Read()` call, leaked on timeout | `application_context/resource_upload_context.go:95-102` |
| 5 | **User-defined SQL via readOnlyDB** - Stored queries execute arbitrary SQL, read-only not enforced at DB level | `application_context/query_context.go:22` |

### API & Backend

| # | Finding | Location |
|---|---------|----------|
| 6 | **Delete on ID=0 not guarded** - Several delete handlers don't check for zero ID | `server/api_handlers/resource_api_handlers.go:378`, `note_api_handlers.go:80-99` |
| 7 | **Multi-file upload double-write** - Error in one file writes response, later code writes again | `server/api_handlers/resource_api_handlers.go:148-170` |
| 8 | **Unbounded JSON body** - No size limit on JSON request bodies (32MB limit only for multipart) | `server/api_handlers/api_handlers.go:42` |
| 9 | **Search limit has no upper bound** - Client can request `?limit=999999999` results | `server/api_handlers/search_api_handlers.go:17` |
| 10 | **Version handlers break DI pattern** - Take concrete `*MahresourcesContext` instead of interfaces | `server/api_handlers/version_api_handlers.go:16` |

### Frontend

| # | Finding | Location |
|---|---------|----------|
| 11 | **Memory leak: `downloadCockpit` keydown listener** - Never removed on destroy | `src/components/downloadCockpit.js:37-41` |
| 12 | **EventSource infinite reconnect** - No backoff, no max retry count | `src/components/downloadCockpit.js:152-159` |
| 13 | **CSS selector injection** - `querySelectorAll` with unsanitized `filter.nameInput` | `src/components/dropdown.js:441` |
| 14 | **Corrupted localStorage crashes app** - `JSON.parse` without try/catch on store init | `src/components/storeConfig.js:4-5` |
| 15 | **Unhandled fetch rejection** - `freeFields.js` fetch has no error handling | `src/components/freeFields.js:56` |
| 16 | **Open redirect via search** - `window.location.href = url` from API data without validation | `src/components/globalSearch.js:233` |

### Testing

| # | Finding | Location |
|---|---------|----------|
| 17 | **CI does not run E2E tests** - Only Go unit tests and staticcheck; no frontend build/test in CI | `.github/workflows/ci.yml` |

---

## MEDIUM (27 findings)

### Data Layer

| # | Finding | Location |
|---|---------|----------|
| 1 | **Data race: `job.ctx`/`job.cancel` modified under wrong lock** | `download_queue/manager.go:394-407` |
| 2 | **Data race: `cleanupOldJobs` reads `CompletedAt` without job mutex** | `download_queue/manager.go:532` |
| 3 | **Cross-DB inconsistency: meta merge uses opposite precedence on SQLite vs PostgreSQL** | `application_context/resource_bulk_context.go:492-498` |
| 4 | **Version context batch errors: partial batch commits on individual failures** | `application_context/resource_version_context.go:665-687` |
| 5 | **Missing panic recovery in thumbnail worker** (unlike hash worker) | `thumbnail_worker/worker.go:78-152` |
| 6 | **`URL.Scan` panics on non-string values** - type assertion without comma-ok | `models/types/url.go:11` |
| 7 | **Unparameterized bool/float64 in PostgreSQL JSON queries** | `models/types/json.go:220-224` |
| 8 | **Group merge SQL may omit required columns in `group_relations`** | `application_context/group_bulk_context.go:64-68` |
| 9 | **`ShowWithSimilar` uses legacy exact-match instead of Hamming distance** | `models/database_scopes/resource_scope.go:64-78` |
| 10 | **SSE event broadcasting after job mutation creates race** | `download_queue/manager.go:404-409` |

### API & Backend

| # | Finding | Location |
|---|---------|----------|
| 11 | **Wrong redirect after group merge** - goes to `/resource?id=` instead of `/group?id=` (copy-paste bug) | `server/api_handlers/group_api_handlers.go:246` |
| 12 | **Negative pagination** - page=0 or negative produces negative DB offsets | `server/api_handlers/resource_api_handlers.go:20-21` |
| 13 | **No CORS/CSP/X-Frame-Options headers** on HTTP server | `server/server.go:15-36` |
| 14 | **Inconsistent error status codes** - validation errors return 500 instead of 400 | Multiple handlers in `api_handlers/` |
| 15 | **Inconsistent request parsing methods** across handlers | Multiple files in `api_handlers/` |
| 16 | **Global decoder as duplicated package-level state** | `api_handlers/api_handlers.go:15`, `template_context_providers.go:10` |
| 17 | **Share server does not rate-limit token attempts** | `server/share_server.go:114-126` |
| 18 | **Multiple sequential queries per list page** (8-9 queries in group list context) | `server/template_handlers/template_context_providers/group_template_context.go:17-115` |

### Frontend

| # | Finding | Location |
|---|---------|----------|
| 19 | **`tableMaker.js` allows `data:image/svg+xml`** which can contain JS | `src/tableMaker.js:242-246` |
| 20 | **Stale Alpine state: morph callbacks blindly preserve `_x_dataStack`** | `src/main.js:142-149`, `pasteUpload.js:446-452` |
| 21 | **`displayQuery.tpl` renders `query.Template` as unescaped HTML** | `templates/displayQuery.tpl:67-69` |
| 22 | **Module-level ID counter generates non-unique IDs** | `src/components/schemaForm.js:151-154` |
| 23 | **`multiSort` meta key not validated inside `formatSort`** | `src/components/multiSort.js:42-48` |
| 24 | **`description.tpl` uses `autoescape off` with markdown** - safety depends on filter | `templates/partials/description.tpl:9-12` |

### Testing & Infrastructure

| # | Finding | Location |
|---|---------|----------|
| 25 | **Hardcoded `waitForTimeout` in E2E tests** creates flakiness risk | Multiple files in `e2e/tests/` |
| 26 | **4 retries in CI masks flaky tests** | `e2e/playwright.config.ts:8` |
| 27 | **Docker Go version mismatch** - Dockerfile uses 1.21, go.mod targets 1.22.5/1.24.1 | `Dockerfile:11` |

---

## LOW (28 findings)

### Data Layer

| # | Finding | Location |
|---|---------|----------|
| 1 | **`limit()` operates on byte length not rune count** - truncates multi-byte UTF-8 incorrectly | `models/group_model.go:48-65` |
| 2 | **Hash cache `warmCache` has no ORDER BY** - arbitrary entries cached for large datasets | `hash_worker/worker.go:329-364` |
| 3 | **`findAndStoreSimilarities` is O(N^2)** for batch processing | `hash_worker/worker.go:426-467` |
| 4 | **LRU cache eviction causes missing similarity pairs** | `hash_worker/worker.go:431-467` |
| 5 | **`::` replacement breaks PostgreSQL type casts** in stored queries | `application_context/query_context.go:22` |
| 6 | **Inconsistent transaction patterns** - mix of `WithTransaction` helper and manual Begin/Commit | Multiple files in `application_context/` |
| 7 | **Note delete without explicit transaction** - multi-association delete not wrapped | `application_context/note_context.go` |
| 8 | **`limit()` uses O(n^2) string concatenation** | `models/group_model.go:53-63` |
| 9 | **`GetDatabaseSchema` uses string interpolation for PRAGMA** | `application_context/query_context.go:153` |

### API & Backend

| # | Finding | Location |
|---|---------|----------|
| 10 | **Dead handler functions after factory migration** | `tag_api_handlers.go:14-35`, `category_api_handlers.go:15-37` |
| 11 | **Inconsistent ID parameter naming** (`id`, `Id`, `ID`) | Multiple files |
| 12 | **Error logging via `fmt.Printf`** instead of structured logger | `server/http_utils/http_helpers.go:87` |
| 13 | **Magic number for multipart form size** (32MB vs 100MB inconsistency) | `api_handlers/api_handlers.go:53`, `version_api_handlers.go:64` |
| 14 | **Unused generic type parameter `T`** in `WithDeleteResponse` | `server/api_handlers/middleware.go:92` |
| 15 | **Inconsistent handler function naming** (`Get*Handler` for POST/DELETE) | Multiple files in `api_handlers/` |
| 16 | **OpenAPI spec and actual routes have naming inconsistencies** | `server/routes_openapi.go` |
| 17 | **45-minute HTTP read/write timeouts** | `server/server.go:33-34` |
| 18 | **SSE event type not sanitized** | `server/api_handlers/download_queue_handlers.go:192` |

### Frontend

| # | Finding | Location |
|---|---------|----------|
| 19 | **Deprecated `document.execCommand` clipboard fallback** | `src/index.js:68-81` |
| 20 | **Hardcoded 30-character truncation** in expandable text | `src/webcomponents/expandabletext.js:61` |
| 21 | **No content hash on `main.js`** - browser cache busting issue | `vite.config.js:12` |
| 22 | **Missing `aria-label` on interactive elements** | `templates/partials/blockEditor.tpl:7`, `lightbox/zoom.js:112` |
| 23 | **Inline edit doesn't announce save to screen readers** | `src/webcomponents/inlineedit.js:186-201` |
| 24 | **`renderMarkdown` doesn't handle nested emphasis** | `src/components/blockEditor.js:43-45` |
| 25 | **No dark mode CSS support** | `public/index.css` |
| 26 | **`DOMContentLoaded` may fire before listener added** (module scripts are deferred) | `src/main.js:110-113` |
| 27 | **`sharedCalendar.js` and `sharedTodos.js` lack `destroy()` methods** | `src/components/sharedCalendar.js`, `sharedTodos.js` |

### Testing & Infrastructure

| # | Finding | Location |
|---|---------|----------|
| 28 | **Massive untested business logic** - 14+ core context files have zero unit tests | `application_context/note_context.go`, `group_crud_context.go`, `tags_context.go`, etc. |
| 29 | **No API handler unit tests for most handlers** - only 4 of 15+ have tests | `server/api_tests/` |
| 30 | **Hardcoded `/tmp/mahresources_ephemeral.db` in tests** - parallel test interference | `application_context/context_test.go:165-166` |
| 31 | **API test `MakeRequest` swallows errors** from `json.Marshal` and `http.NewRequest` | `server/api_tests/api_test_utils.go:99,103` |
| 32 | **Missing models in API test migration** (`Series`, `ResourceVersion`, etc.) | `server/api_tests/api_test_utils.go:42-57` |
| 33 | **E2E duplicate tag test has overly broad assertion** (5 OR'd conditions) | `e2e/tests/01-tag.spec.ts:66` |
| 34 | **No integration tests for download queue actual downloads** | `download_queue/manager_test.go` |
| 35 | **Docker ENV uses `SKIP_FTS=1` by default** - search disabled out of the box | `Dockerfile:33` |
| 36 | **`package.json` main field points to nonexistent `index.js`** | `package.json:4` |
| 37 | **Pre-commit hook unconditionally stages build files** | `.husky/pre-commit:14` |
| 38 | **Test helper uses `panic()` instead of `t.Fatal()`** | `application_context/resource_context_test.go:68-77` |
| 39 | **Custom `contains()` reimplements `strings.Contains`** | `server/openapi/registry_test.go:429-440` |
| 40 | **33 near-identical PNG test assets** add repo bloat | `e2e/test-assets/` |
| 41 | **Single Playwright worker in CI** serializes all tests | `e2e/playwright.config.ts:8` |
| 42 | **E2E shared state pattern creates implicit test dependencies** | Multiple spec files using `test.describe.serial()` |
| 43 | **A11y fixture module-level cache may persist stale data** | `e2e/fixtures/a11y.fixture.ts:10-11` |

---

## Top 10 Recommended Actions

1. **Remove `html.WithUnsafe()`** from the markdown filter, or use a sanitizer like bluemonday
2. **Parameterize FTS queries** - Replace `fmt.Sprintf` with bound parameters in `fts/sqlite.go` and `fts/postgres.go`
3. **Validate URLs** in `renderMarkdown()` link regex - reject `javascript:`, `data:` protocols
4. **Change CASCADE to SET NULL** on Category->Groups, NoteType->Notes, and Group->OwnGroups/OwnNotes
5. **Add graceful shutdown** with `os/signal.Notify` and `http.Server.Shutdown()`
6. **Add `USER` directive** to Dockerfile
7. **Add E2E tests to CI** pipeline
8. **Redact DSN** from startup log output
9. **Add JSON body size limits** and search result caps
10. **Fix group merge redirect** (copy-paste bug: `/resource` should be `/group`)

---

## Positive Observations

The reviewers also noted several strengths:
- Excellent ARIA live region support across components (global search, autocompleter, lightbox, bulk selection)
- Thorough E2E test suite (29 specs, 16K LOC) with accessibility testing
- Well-implemented `destroy()` pattern across most Alpine.js components
- Good keyboard navigation and focus management in the lightbox
- Clean generic CRUD factory pattern reducing boilerplate
- Proper `URL.revokeObjectURL` cleanup in paste upload
- Skip-to-main-content link for accessibility
- Strong hash worker design with LRU cache, batch processing, and panic recovery
- Good test-to-code ratio (~0.97:1)
- Touch gesture support (pinch zoom, swipe navigation) in lightbox
